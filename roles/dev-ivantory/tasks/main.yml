---
# tasks file for dev-ivansible

- import_role:
    name: ivansible.dev-user
  vars:
    dev_user_install_keys: true
    dev_user_setup_system: true
  tags: dev_ivansible_prepare_user


- name: checkout inventory and playbooks
  git:
    dest: "{{ dev_ivansible_dir }}"
    repo: "{{ dev_ivansible_repo }}"
    version: "{{ dev_ivansible_branch }}"
    update: no  # only clone, don't choke on pending modifications
    accept_hostkey: yes


- name: decrypt repository
  import_tasks: transcrypt.yml
  when: "dev_ivansible_password != ''"
  tags: dev_ivansible_decrypt


- name: install system packages
  apt:
    name: "{{ dev_ivansible_system_packages }}"
  become: true

- name: setup virtual environment
  pip:
    requirements: "{{ dev_ivansible_dir }}/requirements.txt"
    virtualenv: "{{ dev_ivansible_dir }}/.venv"
    virtualenv_python: "{{ dev_ivansible_python }}"


- name: template of insecure developer login to vagrant boxes
  # See: http://hakunin.com/six-ansible-practices
  blockinfile:
    dest: .ssh/config
    create: yes
    mode: 0600
    block: |
      Host vagrant-box
        Hostname vagrant-box.dev
        Port {{ ansible_port }}
      {# Never complain about ever-changing host keys #}
        StrictHostKeyChecking no
      {# Never try to remember those keys via known_hosts #}
        UserKnownHostsFile /dev/null
      {# Never report about making such awful things #}
        LogLevel ERROR
    marker: '# {mark} vagrant box example'
  tags: dev_ivansible_ssh_config
...
