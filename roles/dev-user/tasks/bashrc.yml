---
- name: ensure user shell is bash
  user:
    name: "{{ ansible_user_id }}"
    shell: /bin/bash
  become: true

- name: place for custom bash settings
  file:
    path: ~/.local/bashrc
    state: directory

- name: source local settings from bashrc
  lineinfile:
    path: ~/.bashrc
    line: "for bashlet in $(ls -1 ~/.local/bashrc/*.sh); do . $bashlet; done  # ansible-managed"
    regexp: "~/[.]local/bashrc/|[.]bashrc[.]local\\b"

- name: bashrc environment variables
  blockinfile:
    path: ~/.local/bashrc/1env.sh
    block: |
      export BROWSER="firefox"
      export EDITOR="vim"
      export VISUAL="vim"
      export PAGER="less"
      export LESS="-F -X -R"

      {% for var in dev_user_all_vars |sort %}
      export {{ var }}="{{ dev_user_all_vars[var] }}"
      {% endfor %}

      #export AWS_DEFAULT_REGION=""
    insertbefore: BOF
    create: true

- name: bashrc secrets, if permitted
  blockinfile:
    path: ~/.local/bashrc/6secret.sh
    block: |
      {% if is_permitted |bool %}
      {% for var in dev_user_all_secrets |sort %}
      export {{ var }}="{{ dev_user_all_secrets[var] }}"
      {% endfor %}
      {% endif %}
    insertbefore: BOF
    create: true
    mode: 0600

- name: bashrc extra paths
  blockinfile:
    path: ~/.local/bashrc/2path.sh
    block: |
      if [ -n "${PATH##*{{ user_bin }}}" ] && [ -n "${PATH##*{{ user_bin }}:*}" ]; then
          export PATH={{ user_bin }}:$PATH
      fi
    insertbefore: BOF
    marker: "# == {mark} EXTRA USER PATHS =="
    create: true
  vars:
    user_bin: "{{ ansible_user_dir }}/bin"

- name: bashrc local snippets
  blockinfile:
    path: ~/.local/bashrc/3common.sh
    block: "{{ lookup('file', 'bashrc.common.sh') }}"
    insertbefore: BOF
    create: true

- name: bashrc aliases for user
  blockinfile:
    path: ~/.local/bashrc/4alias.sh
    block: "{{ lookup('file', 'bashrc.alias.sh') }}"
    insertbefore: BOF
    create: true

- name: bashrc aliases for root
  become: true
  blockinfile:
    path: /root/.bashrc
    block: "{{ lookup('file', 'bashrc.alias.sh') }}"
    marker: "# == {mark} ANSIBLE ALIASES =="
    insertbefore: BOF
    create: true
  when: ansible_user_id != 'root'

- name: bashrc place for completions
  lineinfile:
    path: ~/.local/bashrc/5completion.sh
    line: "# put your completions here"
    insertbefore: BOF
    create: true

- name: bashrc place for user snippets
  lineinfile:
    path: ~/.local/bashrc/7user.sh
    line: "# put your snippets here"
    insertbefore: BOF
    create: true
...
