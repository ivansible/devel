---
- name: install oath tool
  apt:
    name: oathtool
  become: true
  tags:
    - dev_user_utils
    - dev_user_all

- name: bashrc customizations
  import_tasks: bashrc.yml
  tags:
    - dev_user_bashrc
    - dev_user_all

- name: git config customizations
  import_tasks: git-config.yml
  when: is_permitted |bool
  tags:
    - dev_user_gitconfig
    - dev_user_all


- name: customize tmux
  lineinfile:
    path: ~/.tmux.conf
    line: "{{ item }}"
    create: true
  loop:
    - 'set-option -g history-limit 22000'
    - 'bind -n C-k clear-history'  # clear scroll buffer on Ctrl-K
    - 'bind -n C-u copy-mode -u'   # show scroll buffer on Ctrl-U
    - 'new-session'                # auto-create new sessions
  tags:
    - dev_user_utils
    - dev_user_tmux
    - dev_user_all


- name: ensure .ssh directory exists
  file:
    path: ~/.ssh
    state: directory
    mode: 0700
  tags:
    - dev_user_ssh_all
    - dev_user_all


- name: authorize public keys
  authorized_key:
    user: "{{ ansible_user_id }}"
    key: "{{ lookup('pipe', keygen_cmd) }}"
    comment: "{{ item |basename |regex_replace('[.]key$') }}"
  vars:
    # use '&&' in the pipe to fail on chmod errors
    keygen_cmd: 'chmod 600 "{{ item }}" && ssh-keygen -y -f "{{ item }}"'
  when: item != ''  # noqa 602
  loop: "{{ dev_user_authorized_keys_files }}"
  loop_control:
    label: "{{ item | basename }}"
  tags:
    - dev_user_ssh_all
    - dev_user_ssh_keys
    - dev_user_all

- name: generate ssh config
  import_tasks: ssh-config.yml
  tags:
    - dev_user_ssh_all
    - dev_user_ssh_config
    - dev_user_all

- name: install ssh keys
  import_tasks: ssh-keys.yml
  when: dev_user_install_keys |bool
  tags:
    - dev_user_ssh_all
    - dev_user_ssh_keys
    - dev_user_all


- name: directory for user binaries
  file:
    path: ~/bin
    state: directory
  tags:
    - dev_user_utils
    - dev_user_all


- name: install backup-restore scripts on target host
  import_role:
    name: ivansible.backup_base
    tasks_from: install_scripts.yml
  become: true
  tags:
    - dev_user_utils
    - dev_user_all
...
