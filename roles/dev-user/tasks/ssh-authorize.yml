---
- name: ensure .ssh directory exists
  file:
    path: ~/.ssh
    state: directory
    mode: 0700

- name: authorize new public ssh keys
  authorized_key:
    user: "{{ ansible_user_id }}"
    key: "{{ lookup('pipe', keygen_cmd) }}"
    comment: "{{ key_name }}"
    state: present
  vars:
    key_name: "{{ item |basename |regex_replace('[.]key$') }}"
    # use '&&' in the pipe to fail on chmod errors
    keygen_cmd: 'chmod 600 "{{ item }}" && ssh-keygen -y -f "{{ item }}"'
  loop: "{{ dev_user_ssh_keys_accept }}"
  loop_control:
    label: "{{ key_name }}"

- name: revoke obsolete public ssh keys
  authorized_key:
    user: "{{ ansible_user_id }}"
    key: "{{ lookup('pipe', keygen_cmd) }}"
    state: absent
  vars:
    key_name: "{{ item |basename |regex_replace('[.]key$') }}"
    keygen_cmd: 'chmod 600 "{{ item }}" && ssh-keygen -y -f "{{ item }}"'
  loop: "{{ dev_user_ssh_keys_revoke }}"
  loop_control:
    label: "{{ key_name }}"
...
